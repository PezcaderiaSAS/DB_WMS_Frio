<script type="text/x-template" id="main-template">
   <div class="max-w-6xl mx-auto relative">
      
      <div v-if="mensaje.texto" :class="`mb-4 p-4 rounded shadow text-white ${mensaje.tipo==='error'?'bg-red-500':'bg-green-600'}`">
         {{ mensaje.texto }}
         <a v-if="mensaje.pdf" :href="mensaje.pdf" target="_blank" class="underline ml-2 font-bold bg-white text-green-700 px-2 rounded">VER PDF</a>
         </div>
      <div v-if="vistaActual === 'movimientos'" class="flex gap-6">
         
         <div class="w-1/3 bg-white p-6 rounded shadow h-fit">
            <h2 class="font-bold text-lg mb-4">1. Configurar Movimiento</h2>
            <div class="mb-4">
                  <label class="block text-xs font-bold text-gray-600">Cliente</label>
               <div class="flex gap-2">
                  <select v-model="cabecera.id_cliente" @change="cambiarCliente" class="w-full border p-2 rounded" :disabled="carrito.length > 0">
                     <option value="" disabled>Seleccionar...</option>
                     <option v-for="c in listaClientes" :value="c.id_cliente">{{ c.nombre_razon_social }}</option>
                  </select>
                  <button @click="abrirModal('cliente')" class="bg-gray-200 px-2 rounded hover:bg-gray-300" title="Nuevo Cliente">+</button>
               </div>
               <small v-if="carrito.length > 0" class="text-orange-500 text-xs">Finaliza el pedido actual para cambiar cliente.</small>
            </div>
            <div class="mb-4">
               <label class="block text-xs font-bold text-gray-600">Tipo</label>
               <div class="flex gap-2 bg-gray-100 p-1 rounded">
                  <button @click="cabecera.tipo='ENTRADA'" :class="`flex-1 py-1 rounded ${cabecera.tipo==='ENTRADA'?'bg-green-500 text-white':'text-gray-600'}`">Entrada</button>
                  <button @click="cabecera.tipo='SALIDA'" :class="`flex-1 py-1 rounded ${cabecera.tipo==='SALIDA'?'bg-red-500 text-white':'text-gray-600'}`">Salida</button>
               </div>
            </div>
            <hr class="my-4">
            <h3 class="font-bold text-sm mb-2">Agregar Producto</h3>
            <div class="mb-2">
               <label class="block text-xs text-gray-500">Producto</label>
               <div class="flex gap-2">
                  <select v-model="itemTemp.id_producto" @change="verStock" class="w-full border p-2 rounded">
                     <option value="" disabled>Seleccionar...</option>
                     <option v-for="p in productosFiltrados" :value="p.id_producto">{{ p.nombre_producto }} ({{ p.tipo_empaque }})</option>
                  </select>
                  <button @click="abrirModal('producto')" :disabled="!cabecera.id_cliente" class="bg-gray-200 px-2 rounded hover:bg-gray-300 disabled:opacity-50" title="Nuevo Producto">+</button>
               </div>
                     </div>
            <div v-if="stockInfo" class="text-xs bg-blue-50 p-2 rounded mb-2 border border-blue-200">
               Stock: <b>{{ stockInfo.stock_unidades }}</b> unds | <b>{{ stockInfo.stock_kilos }}</b> kg
            </div>
            <div class="flex gap-2 mb-4">
               <div class="w-1/2">
                  <label class="block text-xs text-gray-500">Cantidad</label>
                  <input type="number" v-model.number="itemTemp.unidades" class="w-full border p-2 rounded" min="1">
               </div>
               <div class="w-1/2">
                  <label class="block text-xs text-gray-500">Peso (Kg)</label>
                  <input type="number" v-model.number="itemTemp.kilos" class="w-full border p-2 rounded" min="0.1" step="0.01">
               </div>
            </div>
            <button @click="agregarAlCarrito" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">
               Agregar a la Lista ⬇
            </button>
            </div>
         <div class="w-2/3 bg-white p-6 rounded shadow flex flex-col">
            <h2 class="font-bold text-lg mb-4 flex justify-between">
               <span>2. Lista de Movimientos</span>
               <span class="text-sm font-normal bg-gray-100 px-2 py-1 rounded">{{ carrito.length }} Ítems</span>
            </h2>
            <div class="flex-1 overflow-auto border rounded mb-4">
               <table class="w-full text-sm text-left">
                  <thead class="bg-gray-50 sticky top-0">
                     <tr>
                        <th class="p-2">Producto</th>
                        <th class="p-2 text-right">Cant.</th>
                        <th class="p-2 text-right">Peso</th>
                        <th class="p-2 text-center">Acción</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr v-for="(item, idx) in carrito" :key="idx" class="border-b">
                        <td class="p-2">{{ obtenerNombreProd(item.id_producto) }}</td>
                        <td class="p-2 text-right">{{ item.unidades }}</td>
                        <td class="p-2 text-right">{{ item.kilos }}</td>
                        <td class="p-2 text-center">
                           <button @click="carrito.splice(idx, 1)" class="text-red-500 hover:text-red-700">✕</button>
                        </td>
                     </tr>
                     <tr v-if="carrito.length === 0">
                        <td colspan="4" class="p-8 text-center text-gray-400">No hay productos agregados.</td>
                     </tr>
                  </tbody>
               </table>
            </div>
            <div class="flex justify-end gap-3">
               <button v-if="carrito.length > 0" @click="carrito = []" class="text-red-500 text-sm hover:underline">Limpiar Todo</button>
               <button @click="procesarPedido" :disabled="carrito.length===0 || procesando" 
                  class="bg-green-600 text-white px-6 py-3 rounded font-bold hover:bg-green-700 disabled:opacity-50 shadow-lg">
                  <span v-if="!procesando">CONFIRMAR MOVIMIENTO ({{ carrito.length }})</span>
                  <span v-else>Procesando...</span>
               </button>
            </div>
         </div>
         </div>
      <div v-if="modales.cliente" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
         <div class="bg-white p-6 rounded w-96 shadow-xl">
            <h3 class="font-bold text-lg mb-4">Nuevo Cliente</h3>
            <form @submit.prevent="guardarClienteRapido">
               <input v-model="formCliente.nombre" placeholder="Razón Social" class="w-full border p-2 mb-2 rounded" required>
               <input v-model="formCliente.email" placeholder="Email" class="w-full border p-2 mb-2 rounded" required>
               <div class="flex justify-end gap-2 mt-4">
                  <button type="button" @click="modales.cliente = false" class="text-gray-500 px-3">Cancelar</button>
                  <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Guardar</button>
               </div>
            </form>
         </div>
         </div>
      <div v-if="modales.producto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
         <div class="bg-white p-6 rounded w-[800px] shadow-xl h-[80vh] flex flex-col">
            <h3 class="font-bold text-lg mb-2">Carga Masiva de Productos</h3>
            <p class="text-xs text-gray-500 mb-4">Para el cliente: <b>{{ nombreClienteActual }}</b>. Copia y pega desde Excel (Nombre | Empaque) o escribe manualmente.</p>
            
            <div class="flex-1 overflow-auto border rounded bg-gray-50 p-2">
               <table class="w-full bg-white">
                  <thead>
                     <tr class="text-xs text-gray-500 border-b">
                        <th class="w-10 text-center">#</th>
                        <th class="p-1">Nombre Producto</th>
                        <th class="p-1">Tipo Empaque</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr v-for="(fila, i) in loteProductos" :key="i">
                        <td class="text-center text-gray-400 text-xs">{{ i+1 }}</td>
                        <td class="p-1"><input v-model="fila.nombre" class="w-full border p-1 rounded text-sm"></td>
                        <td class="p-1"><input v-model="fila.empaque" class="w-full border p-1 rounded text-sm"></td>
                     </tr>
                  </tbody>
               </table>
               <button @click="agregarFilasLote" class="mt-2 text-blue-600 text-xs hover:underline">+ Agregar 5 filas más</button>
            </div>
            <div class="mt-4 border-t pt-2">
               <details>
                  <summary class="text-xs text-blue-600 cursor-pointer">O pegar desde Excel aquí...</summary>
                  <textarea v-model="textoPegado" @input="parsearTextoPegado" class="w-full h-20 border text-xs p-2 mt-1" placeholder="Copia las columnas Nombre y Empaque en Excel y pégalas aquí..."></textarea>
               </details>
            </div>
            <div class="flex justify-end gap-2 mt-4 pt-2 border-t">
               <button type="button" @click="modales.producto = false" class="text-gray-500 px-3">Cancelar</button>
               <button type="button" @click="guardarLoteProductos" class="bg-purple-600 text-white px-4 py-2 rounded font-bold">Guardar Productos</button>
            </div>
         </div>
      </div>
</script>