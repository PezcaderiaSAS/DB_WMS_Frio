<script type="text/x-template" id="main-template">
   <div class="max-w-7xl mx-auto relative">
      
      <!-- MENSAJE FLOTANTE -->
      <div v-if="mensaje.texto" :class="`mb-4 p-4 rounded shadow text-white ${mensaje.tipo==='error'?'bg-red-500':'bg-green-600'}`">
         {{ mensaje.texto }}
         <a v-if="mensaje.pdf" :href="mensaje.pdf" target="_blank" class="underline ml-2 font-bold bg-white text-green-700 px-2 rounded">VER PDF</a>
      </div>

      <!-- VISTA: MOVIMIENTOS -->
      <div v-if="vistaActual === 'movimientos'" class="flex gap-6">
         
         <div class="w-1/3 bg-white p-6 rounded shadow h-fit">
            <h2 class="font-bold text-lg mb-4">1. Configurar Movimiento</h2>
            <div class="mb-4">
                  <label class="block text-xs font-bold text-gray-600">Cliente</label>
               <div class="flex gap-2">
                  <select v-model="cabecera.id_cliente" @change="cambiarCliente" class="w-full border p-2 rounded" :disabled="carrito.length > 0">
                     <option value="" disabled>Seleccionar...</option>
                     <option v-for="c in listaClientes" :value="c.id_cliente">{{ c.nombre_razon_social }}</option>
                  </select>
                  <button @click="abrirModal('cliente')" class="bg-gray-200 px-2 rounded hover:bg-gray-300" title="Nuevo Cliente">+</button>
               </div>
               <small v-if="carrito.length > 0" class="text-orange-500 text-xs">Finaliza el pedido actual para cambiar cliente.</small>
            </div>
            <div class="mb-4">
               <label class="block text-xs font-bold text-gray-600">Tipo</label>
               <div class="flex gap-2 bg-gray-100 p-1 rounded">
                  <button @click="cabecera.tipo='ENTRADA'" :class="`flex-1 py-1 rounded ${cabecera.tipo==='ENTRADA'?'bg-green-500 text-white':'text-gray-600'}`">Entrada</button>
                  <button @click="cabecera.tipo='SALIDA'" :class="`flex-1 py-1 rounded ${cabecera.tipo==='SALIDA'?'bg-red-500 text-white':'text-gray-600'}`">Salida</button>
               </div>
            </div>
            <hr class="my-4">
            <h3 class="font-bold text-sm mb-2">Agregar Producto</h3>
            <div class="mb-2">
               <label class="block text-xs text-gray-500">Producto</label>
               <div class="flex gap-2">
                  <select v-model="itemTemp.id_producto" @change="verStock" class="w-full border p-2 rounded">
                     <option value="" disabled>Seleccionar...</option>
                     <option v-for="p in productosFiltrados" :value="p.id_producto">{{ p.nombre_producto }} ({{ p.tipo_empaque }})</option>
                  </select>
                  <button @click="abrirModal('producto')" :disabled="!cabecera.id_cliente" class="bg-gray-200 px-2 rounded hover:bg-gray-300 disabled:opacity-50" title="Nuevo Producto">+</button>
               </div>
                     </div>
            <div v-if="stockInfo" class="text-xs bg-blue-50 p-2 rounded mb-2 border border-blue-200">
               Stock: <b>{{ stockInfo.stock_unidades }}</b> unds | <b>{{ stockInfo.stock_kilos }}</b> kg
            </div>
            <div class="flex gap-2 mb-4">
               <div class="w-1/2">
                  <label class="block text-xs text-gray-500">Cantidad</label>
                  <input type="number" v-model.number="itemTemp.unidades" class="w-full border p-2 rounded" min="1">
               </div>
               <div class="w-1/2">
                  <label class="block text-xs text-gray-500">Peso (Kg)</label>
                  <input type="number" v-model.number="itemTemp.kilos" class="w-full border p-2 rounded" min="0.1" step="0.01">
               </div>
            </div>
            <button @click="agregarAlCarrito" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold">
               Agregar a la Lista ⬇
            </button>
            </div>
         <div class="w-2/3 bg-white p-6 rounded shadow flex flex-col">
            <h2 class="font-bold text-lg mb-4 flex justify-between">
               <span>2. Lista de Movimientos</span>
               <span class="text-sm font-normal bg-gray-100 px-2 py-1 rounded">{{ carrito.length }} Ítems</span>
            </h2>
            <div class="flex-1 overflow-auto border rounded mb-4">
               <table class="w-full text-sm text-left">
                  <thead class="bg-gray-50 sticky top-0">
                     <tr>
                        <th class="p-2">Producto</th>
                        <th class="p-2 text-right">Cant.</th>
                        <th class="p-2 text-right">Peso</th>
                        <th class="p-2 text-center">Acción</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr v-for="(item, idx) in carrito" :key="idx" class="border-b">
                        <td class="p-2">{{ obtenerNombreProd(item.id_producto) }}</td>
                        <td class="p-2 text-right">{{ item.unidades }}</td>
                        <td class="p-2 text-right">{{ item.kilos }}</td>
                        <td class="p-2 text-center">
                           <button @click="carrito.splice(idx, 1)" class="text-red-500 hover:text-red-700">✕</button>
                        </td>
                     </tr>
                     <tr v-if="carrito.length === 0">
                        <td colspan="4" class="p-8 text-center text-gray-400">No hay productos agregados.</td>
                     </tr>
                  </tbody>
               </table>
            </div>
            <div class="flex justify-end gap-3">
               <button v-if="carrito.length > 0" @click="carrito = []" class="text-red-500 text-sm hover:underline">Limpiar Todo</button>
               <button @click="procesarPedido" :disabled="carrito.length===0 || procesando" 
                  class="bg-green-600 text-white px-6 py-3 rounded font-bold hover:bg-green-700 disabled:opacity-50 shadow-lg">
                  <span v-if="!procesando">CONFIRMAR MOVIMIENTO ({{ carrito.length }})</span>
                  <span v-else>Procesando...</span>
               </button>
            </div>
         </div>
         </div>
      <div v-if="modales.cliente" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
         <div class="bg-white p-6 rounded w-96 shadow-xl">
            <h3 class="font-bold text-lg mb-4">Nuevo Cliente</h3>
            <form @submit.prevent="guardarClienteRapido">
               <input v-model="formCliente.nombre" placeholder="Razón Social" class="w-full border p-2 mb-2 rounded" required>
               <input v-model="formCliente.email" placeholder="Email" class="w-full border p-2 mb-2 rounded" required>
               <div class="flex justify-end gap-2 mt-4">
                  <button type="button" @click="modales.cliente = false" class="text-gray-500 px-3">Cancelar</button>
                  <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Guardar</button>
               </div>
            </form>
         </div>
         </div>
      <div v-if="modales.producto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
         <div class="bg-white p-6 rounded w-[800px] shadow-xl h-[80vh] flex flex-col">
            <h3 class="font-bold text-lg mb-2">Carga Masiva de Productos</h3>
            <p class="text-xs text-gray-500 mb-4">Para el cliente: <b>{{ nombreClienteActual }}</b>. Copia y pega desde Excel (Nombre | Empaque) o escribe manualmente.</p>
            
            <div class="flex-1 overflow-auto border rounded bg-gray-50 p-2">
               <table class="w-full bg-white">
                  <thead>
                     <tr class="text-xs text-gray-500 border-b">
                        <th class="w-10 text-center">#</th>
                        <th class="p-1">Nombre Producto</th>
                        <th class="p-1">Tipo Empaque</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr v-for="(fila, i) in loteProductos" :key="i">
                        <td class="text-center text-gray-400 text-xs">{{ i+1 }}</td>
                        <td class="p-1"><input v-model="fila.nombre" class="w-full border p-1 rounded text-sm"></td>
                        <td class="p-1"><input v-model="fila.empaque" class="w-full border p-1 rounded text-sm"></td>
                     </tr>
                  </tbody>
               </table>
               <button @click="agregarFilasLote" class="mt-2 text-blue-600 text-xs hover:underline">+ Agregar 5 filas más</button>
            </div>
            <div class="mt-4 border-t pt-2">
               <details>
                  <summary class="text-xs text-blue-600 cursor-pointer">O pegar desde Excel aquí...</summary>
                  <textarea v-model="textoPegado" @input="parsearTextoPegado" class="w-full h-20 border text-xs p-2 mt-1" placeholder="Copia las columnas Nombre y Empaque en Excel y pégalas aquí..."></textarea>
               </details>
            </div>
            <div class="flex justify-end gap-2 mt-4 pt-2 border-t">
               <button type="button" @click="modales.producto = false" class="text-gray-500 px-3">Cancelar</button>
               <button type="button" @click="guardarLoteProductos" class="bg-purple-600 text-white px-4 py-2 rounded font-bold">Guardar Productos</button>
            </div>
         </div>
      </div>

      <!-- VISTA: CREAR CLIENTE -->
      <div v-if="vistaActual === 'nuevo_cliente'" class="bg-white rounded shadow p-8 max-w-2xl">
         <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span class="material-icons text-blue-600">person_add</span>
            Crear Nuevo Cliente
         </h2>
         <form @submit.prevent="guardarClienteCompleto" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">ID/Identificación *</label>
                  <input v-model="formClienteCompleto.id_cliente" type="text" class="w-full border p-3 rounded" placeholder="CC, NIT, etc." required>
               </div>
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Tipo Documento *</label>
                  <select v-model="formClienteCompleto.tipo_documento" class="w-full border p-3 rounded">
                     <option value="CC">Cédula</option>
                     <option value="NIT">NIT</option>
                     <option value="CE">Cédula Extranjería</option>
                     <option value="PP">Pasaporte</option>
                  </select>
               </div>
            </div>
            <div>
               <label class="block text-sm font-bold text-gray-700 mb-1">Nombre/Razón Social *</label>
               <input v-model="formClienteCompleto.nombre_razon_social" type="text" class="w-full border p-3 rounded" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Email</label>
                  <input v-model="formClienteCompleto.email" type="email" class="w-full border p-3 rounded">
               </div>
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Teléfono</label>
                  <input v-model="formClienteCompleto.telefono" type="text" class="w-full border p-3 rounded">
               </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Ciudad</label>
                  <input v-model="formClienteCompleto.ciudad" type="text" class="w-full border p-3 rounded">
               </div>
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Departamento</label>
                  <input v-model="formClienteCompleto.departamento" type="text" class="w-full border p-3 rounded">
               </div>
            </div>
            <div>
               <label class="block text-sm font-bold text-gray-700 mb-1">Dirección</label>
               <input v-model="formClienteCompleto.direccion" type="text" class="w-full border p-3 rounded">
            </div>
            <div class="flex gap-3 pt-4 border-t">
               <button type="submit" :disabled="guardandoCliente" class="bg-green-600 text-white px-6 py-3 rounded font-bold hover:bg-green-700 disabled:opacity-50">
                  {{ guardandoCliente ? 'Guardando...' : 'Crear Cliente' }}
               </button>
            </div>
         </form>
      </div>

      <!-- VISTA: CREAR PRODUCTO -->
      <div v-if="vistaActual === 'nuevo_producto'" class="bg-white rounded shadow p-8 max-w-2xl">
         <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span class="material-icons text-blue-600">add_box</span>
            Crear Nuevo Producto
         </h2>
         <form @submit.prevent="guardarProductoCompleto" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">SKU *</label>
                  <input v-model="formProductoCompleto.sku" type="text" class="w-full border p-3 rounded" placeholder="Ej: PRD-001" required>
               </div>
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Estado</label>
                  <select v-model="formProductoCompleto.estado" class="w-full border p-3 rounded">
                     <option value="Activo">Activo</option>
                     <option value="Inactivo">Inactivo</option>
                     <option value="Descontinuado">Descontinuado</option>
                  </select>
               </div>
            </div>
            <div>
               <label class="block text-sm font-bold text-gray-700 mb-1">Nombre *</label>
               <input v-model="formProductoCompleto.nombre" type="text" class="w-full border p-3 rounded" required>
            </div>
            <div>
               <label class="block text-sm font-bold text-gray-700 mb-1">Descripción</label>
               <textarea v-model="formProductoCompleto.descripcion" class="w-full border p-3 rounded h-20"></textarea>
            </div>
            <div class="grid grid-cols-3 gap-4">
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Categoría</label>
                  <input v-model="formProductoCompleto.categoria" type="text" class="w-full border p-3 rounded">
               </div>
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Unidad</label>
                  <input v-model="formProductoCompleto.unidad" type="text" class="w-full border p-3 rounded" placeholder="Unid, Kg, etc">
               </div>
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Impuesto (%)</label>
                  <input v-model.number="formProductoCompleto.impuesto" type="number" class="w-full border p-3 rounded" min="0">
               </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="block text-sm font-bold text-gray-700 mb-1">Precio</label>
                  <input v-model.number="formProductoCompleto.precio" type="number" class="w-full border p-3 rounded" min="0">
               </div>
            </div>
            <div class="flex gap-3 pt-4 border-t">
               <button type="submit" :disabled="guardandoProducto" class="bg-green-600 text-white px-6 py-3 rounded font-bold hover:bg-green-700 disabled:opacity-50">
                  {{ guardandoProducto ? 'Guardando...' : 'Crear Producto' }}
               </button>
            </div>
         </form>
      </div>

      <!-- VISTA: INVENTARIO -->
      <div v-if="vistaActual === 'inventario'" class="bg-white rounded shadow p-8">
         <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span class="material-icons text-blue-600">inventory_2</span>
            Ver Inventario
         </h2>
         
         <div class="mb-4">
            <input v-model="filtroInventario" type="text" placeholder="Buscar por nombre o SKU..." class="w-full border p-3 rounded">
         </div>

         <div class="overflow-x-auto rounded border">
            <table class="w-full text-sm">
               <thead class="bg-gray-100 border-b">
                  <tr>
                     <th class="p-3 text-left">SKU</th>
                     <th class="p-3 text-left">Nombre</th>
                     <th class="p-3 text-left">Categoría</th>
                     <th class="p-3 text-left">Unidad</th>
                     <th class="p-3 text-center">Estado</th>
                     <th class="p-3 text-right">Precio</th>
                     <th class="p-3 text-right">Impuesto</th>
                  </tr>
               </thead>
               <tbody>
                  <tr v-for="prod in productosFiltradosInventario" :key="prod.SKU" class="border-b hover:bg-gray-50">
                     <td class="p-3 font-mono text-sm text-gray-700">{{ prod.SKU }}</td>
                     <td class="p-3">{{ prod.Nombre }}</td>
                     <td class="p-3">{{ prod.Categoría || '-' }}</td>
                     <td class="p-3">{{ prod.Unidad }}</td>
                     <td class="p-3 text-center">
                        <span :class="`px-2 py-1 rounded text-xs font-bold ${prod.Estado === 'Activo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`">
                           {{ prod.Estado }}
                        </span>
                     </td>
                     <td class="p-3 text-right">${{ prod.Precio || 0 }}</td>
                     <td class="p-3 text-right">{{ prod.Impuesto || 0 }}%</td>
                  </tr>
                  <tr v-if="productosFiltradosInventario.length === 0">
                     <td colspan="7" class="p-8 text-center text-gray-400">No hay productos que coincidan con tu búsqueda.</td>
                  </tr>
               </tbody>
            </table>
         </div>
      </div>
   </div>
</script>